name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint_unit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        poetry --version

    - name: Install dependencies
      run: |
        poetry config virtualenvs.create false
        poetry install --no-root --no-interaction --no-ansi

    - name: Run Ruff linter
      run: poetry run ruff check .

    - name: Run MyPy type checker
      run: poetry run mypy mcp rag --strict

    - name: Run unit tests (excluding E2E)
      run: poetry run pytest tests/ -m "not e2e" --tb=short

  docker_build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t mcp-rag:latest .

    - name: Verify image was built
      run: docker images mcp-rag:latest

  e2e:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image for E2E
      run: docker build -t mcp-rag:e2e .

    - name: Run E2E test in container
      run: |
        echo "Running E2E test..."

        # Copy the test script and run it in the container
        docker run --rm \
          -v "$(pwd)/scripts:/app/scripts" \
          -v "$(pwd)/knowledge:/app/knowledge" \
          -v "$(pwd)/rag/store:/app/rag/store" \
          --entrypoint bash \
          mcp-rag:e2e \
          /app/scripts/ci_e2e_test.sh
